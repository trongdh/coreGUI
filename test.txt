import pysftp
from datetime import datetime, timedelta

# Function to connect to SFTP and fetch files modified within the datetime range
def fetch_files_between_datetimes(start_datetime, end_datetime):
    # SFTP credentials
    sftp_host = 'your_sftp_host'
    sftp_username = 'your_username'
    sftp_password = 'your_password'
    
    try:
        # Establish SFTP connection
        with pysftp.Connection(host=sftp_host, username=sftp_username, password=sftp_password) as sftp:
            # List directories/files within the date range folders
            current_datetime = start_datetime
            while current_datetime <= end_datetime:
                folder_to_check = current_datetime.strftime("%Y-%m-%d")
                sftp.cwd('/')  # Navigate to the root directory of the SFTP server
                sftp.cwd(folder_to_check)  # Navigate to the specific date folder
                
                files_in_folder = sftp.listdir_attr()  # List file attributes in the folder
                
                # Download files modified within the date range
                for file_attr in files_in_folder:
                    file_mod_time = file_attr.st_mtime  # Get file modification time
                    file_datetime = datetime.fromtimestamp(file_mod_time)
                    
                    # Check if file modification time is within the input range
                    if start_datetime <= file_datetime <= end_datetime:
                        # Download the file
                        sftp.get(file_attr.filename)  # Download the file
                    
                current_datetime += timedelta(days=1)  # Move to the next day
                
    except Exception as e:
        print("An error occurred:", e)

# Example usage:
start_datetime = datetime(2024, 1, 1, 8, 0)  # Replace with your start datetime (year, month, day, hour, minute)
end_datetime = datetime(2024, 1, 10, 18, 30)  # Replace with your end datetime (year, month, day, hour, minute)

# Call the function to fetch files modified within the specified datetimes
fetch_files_between_datetimes(start_datetime, end_datetime)